{% extends 'base.html' %}

{% block title %}–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="form-card p-5">
            <div class="text-center mb-5">
                <h1 class="fw-bold text-success mb-3">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞</h1>
                <p class="text-muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            </div>

            <form method="post" id="booking-form">
                {% csrf_token %}

                <!-- –û—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger rounded-3 mb-4">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <!-- –í—ã–±–æ—Ä –Ω–æ–º–µ—Ä–∞ -->
                <div class="mb-4">
                    <label class="form-label fw-medium text-dark">{{ form.room.label }}</label>
                    {{ form.room }}
                    {% if form.room.errors %}
                        <div class="invalid-feedback d-block">{{ form.room.errors.0 }}</div>
                    {% endif %}
                    <small class="text-muted mt-1 d-block">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</small>
                </div>

                <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å –∑–∞–Ω—è—Ç—ã–º–∏ –¥–∞—Ç–∞–º–∏ -->
                <div class="form-card p-4 mb-4 bg-light">
                    <h6 class="fw-bold text-success mb-3">üóìÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã (–∫—Ä–∞—Å–Ω—ã–º –æ—Ç–º–µ—á–µ–Ω—ã –∑–∞–Ω—è—Ç—ã–µ –¥–∞—Ç—ã)</h6>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-medium">{{ form.check_in.label }}</label>
                            {{ form.check_in }}
                            {% if form.check_in.errors %}
                                <div class="invalid-feedback d-block">{{ form.check_in.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">{{ form.check_out.label }}</label>
                            {{ form.check_out }}
                            {% if form.check_out.errors %}
                                <div class="invalid-feedback d-block">{{ form.check_out.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- –ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –º–µ—Å—è—Ü -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0" id="calendar-month"></h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeMonth(-1)">‚Üê</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="changeMonth(1)">‚Üí</button>
                            </div>
                        </div>
                        <div id="calendar" class="calendar-grid"></div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <span class="badge bg-danger me-2">–ó–∞–Ω—è—Ç–æ</span>
                                <span class="badge bg-success me-2">–°–≤–æ–±–æ–¥–Ω–æ</span>
                                <span class="badge bg-info me-2">–°–µ–≥–æ–¥–Ω—è</span>
                                <span class="badge bg-warning">–í—ã–±—Ä–∞–Ω–æ</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π -->
                <div class="mb-4">
                    <label class="form-label fw-medium text-dark">{{ form.guests.label }}</label>
                    {{ form.guests }}
                    {% if form.guests.errors %}
                        <div class="invalid-feedback d-block">{{ form.guests.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
                <div class="mb-5">
                    <label class="form-label fw-medium text-dark">{{ form.notes.label }}</label>
                    {{ form.notes }}
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏ -->
                <div class="form-card bg-light p-4 mb-5">
                    <h5 class="fw-bold text-success mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —Å—É—Ç–∫–∏:</strong> <span id="price-per-day">-</span> ‚ÇΩ</p>
                            <p class="mb-2"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π:</strong> <span id="nights">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> <span id="total-price" class="h5 text-success">-</span> ‚ÇΩ</p>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="d-flex gap-3">
                    <button type="submit" class="btn btn-custom text-white flex-grow-1 py-3" id="submit-btn">
                        –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <a href="{% url 'rooms' %}" class="btn btn-outline-secondary py-3">
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let busyDates = [];
let selectedRoomId = null;

// –ú–µ—Å—è—Ü—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º
const monthNames = [
    '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
    '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
];

// –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];

document.addEventListener('DOMContentLoaded', function() {
    const roomSelect = document.querySelector('#id_room');
    const checkInInput = document.querySelector('#id_check_in');
    const checkOutInput = document.querySelector('#id_check_out');
    const guestsInput = document.querySelector('#id_guests');
    const submitBtn = document.querySelector('#submit-btn');

    const pricePerDayEl = document.getElementById('price-per-day');
    const nightsEl = document.getElementById('nights');
    const totalPriceEl = document.getElementById('total-price');

    // –ö—ç—à —Ü–µ–Ω –Ω–æ–º–µ—Ä–æ–≤
    const roomPrices = {};

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ü–µ–Ω—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
    {% if form.room.field.queryset %}
        {% for room in form.room.field.queryset %}
            roomPrices[{{ room.id }}] = {{ room.price_per_day }};
        {% endfor %}
    {% endif %}

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    function calculateTotal() {
        const roomId = roomSelect.value;
        const checkIn = checkInInput.value;
        const checkOut = checkOutInput.value;

        if (roomId && checkIn && checkOut) {
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);

            if (!isNaN(checkInDate) && !isNaN(checkOutDate)) {
                const pricePerDay = roomPrices[roomId] || 0;
                const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

                if (nights > 0) {
                    pricePerDayEl.textContent = pricePerDay.toLocaleString('ru-RU');
                    nightsEl.textContent = nights;
                    totalPriceEl.textContent = (pricePerDay * nights).toLocaleString('ru-RU');
                    return true;
                }
            }
        }

        pricePerDayEl.textContent = '-';
        nightsEl.textContent = '-';
        totalPriceEl.textContent = '-';
        return false;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–Ω—è—Ç—ã—Ö –¥–∞—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
    async function loadBusyDates(roomId) {
        try {
            const response = await fetch(`/accounts/api/room/${roomId}/busy-dates/`);
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');

            const data = await response.json();
            if (data.success) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–µ—Ä–∏–æ–¥—ã –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –≤ –º–∞—Å—Å–∏–≤ –¥–∞—Ç
                busyDates = [];
                data.busy_periods.forEach(period => {
                    const start = new Date(period.start);
                    const end = new Date(period.end);

                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –¥–∞—Ç—ã –≤ –ø–µ—Ä–∏–æ–¥–µ
                    let current = new Date(start);
                    while (current <= end) {
                        busyDates.push(current.toISOString().split('T')[0]);
                        current.setDate(current.getDate() + 1);
                    }
                });

                // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                busyDates = [...new Set(busyDates)];

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                renderCalendar();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–Ω—è—Ç—ã—Ö –¥–∞—Ç:', error);
            busyDates = [];
            renderCalendar();
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–Ω—è—Ç–∞ –ª–∏ –¥–∞—Ç–∞
    function isDateBusy(dateStr) {
        return busyDates.includes(dateStr);
    }

// –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–º–∏ —Ä—è–¥–∞–º–∏
    function renderCalendar() {
    const calendarEl = document.getElementById('calendar');
    const monthTitleEl = document.getElementById('calendar-month');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    monthTitleEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

    // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    const firstDay = new Date(currentYear, currentMonth, 1);
    // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0-–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1-–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏ —Ç.–¥.)
    let firstDayOfWeek = firstDay.getDay();
    if (firstDayOfWeek === 0) firstDayOfWeek = 6; // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ –∫–æ–Ω–µ—Ü
    else firstDayOfWeek -= 1;

    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
    const daysInMonth = lastDay.getDate();

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ (—Ä—è–¥–æ–≤)
    const totalCells = firstDayOfWeek + daysInMonth;
    const rows = Math.ceil(totalCells / 7);

    // –¢–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
    const checkIn = document.querySelector('#id_check_in').value;
    const checkOut = document.querySelector('#id_check_out').value;

    // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞ - –ö–û–†–†–ï–ö–¢–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï
    const today = new Date();
    const todayYear = today.getFullYear();
    const todayMonth = today.getMonth();
    const todayDay = today.getDate();

    let html = '<div class="row mb-2">';

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
    dayNames.forEach(day => {
        html += `<div class="col text-center text-muted small fw-medium">${day}</div>`;
    });

    html += '</div>';

    let dayCounter = 1;

    // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
    for (let row = 0; row < rows; row++) {
        html += '<div class="row">';

        // 7 –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª–µ
        for (let col = 0; col < 7; col++) {
            const cellIndex = row * 7 + col;

            if (cellIndex >= firstDayOfWeek && dayCounter <= daysInMonth) {
                // –≠—Ç–æ –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ - –§–ò–ö–° –ü–†–û–ë–õ–ï–ú–´ –° –î–ê–¢–ê–ú–ò
                const date = new Date(currentYear, currentMonth, dayCounter);

                // –ö–û–†–†–ï–ö–¢–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ë–ï–ó –ü–†–û–ë–õ–ï–ú –ß–ê–°–û–í–û–ì–û –ü–û–Ø–°–ê
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–µ–≥–æ–¥–Ω—è –ª–∏ —ç—Ç–æ
                const isToday = (currentYear === todayYear &&
                                 currentMonth === todayMonth &&
                                 dayCounter === todayDay);

                const isPast = date < new Date(today.setHours(0, 0, 0, 0));
                const isBusy = isDateBusy(dateStr);
                const isSelected = dateStr === checkIn || dateStr === checkOut;
                const isInRange = checkIn && checkOut && date >= new Date(checkIn) && date <= new Date(checkOut);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å—ã
                let dayClass = 'calendar-day';
                let disabled = false;

                if (isToday) dayClass += ' today';
                if (isPast) dayClass += ' past';
                if (isBusy) {
                    dayClass += ' busy';
                    disabled = true;
                }
                if (isSelected) dayClass += ' selected';
                if (isInRange) dayClass += ' in-range';

                html += `
                    <div class="col p-1">
                        <button type="button"
                                class="${dayClass}"
                                ${disabled ? 'disabled' : ''}
                                onclick="selectDate('${dateStr}')"
                                title="${date.toLocaleDateString('ru-RU')}${isBusy ? ' (–ó–∞–Ω—è—Ç–æ)' : ''}">
                            ${dayCounter}
                        </button>
                    </div>
                `;

                dayCounter++;
            } else if (cellIndex < firstDayOfWeek) {
                // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –≤ –Ω–∞—á–∞–ª–µ –º–µ—Å—è—Ü–∞
                html += '<div class="col p-1"></div>';
            } else {
                // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞
                // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é –∫–æ–ª–æ–Ω–∫—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è
                html += '<div class="col p-1"></div>';
            }
        }

        html += '</div>';
    }

    calendarEl.innerHTML = html;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    updateSubmitButton();
}

    // –í—ã–±–æ—Ä –¥–∞—Ç—ã
window.selectDate = function(dateStr) {
    const checkInInput = document.querySelector('#id_check_in');
    const checkOutInput = document.querySelector('#id_check_out');

    if (isDateBusy(dateStr)) {
        alert('–≠—Ç–∞ –¥–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.');
        return;
    }

    // dateStr —É–∂–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
    // –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π

    if (!checkInInput.value) {
        // –í—ã–±–æ—Ä –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞
        checkInInput.value = dateStr;
        checkOutInput.min = dateStr;
        checkOutInput.value = '';
    } else if (!checkOutInput.value) {
        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—ã –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
        if (dateStr > checkInInput.value) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –∑–∞–Ω—è—Ç—ã—Ö –¥–∞—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
            if (checkRangeForBusyDates(checkInInput.value, dateStr)) {
                checkOutInput.value = dateStr;
            } else {
                alert('–í –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –µ—Å—Ç—å –∑–∞–Ω—è—Ç—ã–µ –¥–∞—Ç—ã.');
                return;
            }
        } else {
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω—è—è –∏–ª–∏ —Ç–∞ –∂–µ –¥–∞—Ç–∞, –¥–µ–ª–∞–µ–º –µ—ë –¥–∞—Ç–æ–π –∑–∞–µ–∑–¥–∞
            checkInInput.value = dateStr;
            checkOutInput.value = '';
            checkOutInput.min = dateStr;
        }
    } else {
        // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
        checkInInput.value = dateStr;
        checkOutInput.value = '';
        checkOutInput.min = dateStr;
    }

    calculateTotal();
    renderCalendar();
};

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–Ω—è—Ç—ã—Ö –¥–∞—Ç
function checkRangeForBusyDates(startStr, endStr) {
    const start = new Date(startStr);
    const end = new Date(endStr);
    let current = new Date(start);

    // –ò—Ç–µ—Ä–∏—Ä—É–µ–º –ø–æ –≤—Å–µ–º –¥–∞—Ç–∞–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    while (current <= end) {
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É —Ç–∞–∫ –∂–µ, –∫–∞–∫ –≤ renderCalendar
        const year = current.getFullYear();
        const month = String(current.getMonth() + 1).padStart(2, '0');
        const day = String(current.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;

        if (isDateBusy(dateStr)) {
            return false; // –ù–∞—à–ª–∏ –∑–∞–Ω—è—Ç—É—é –¥–∞—Ç—É
        }

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é
        current.setDate(current.getDate() + 1);
    }

    return true; // –í—Å–µ –¥–∞—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã
}

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    function updateSubmitButton() {
        const roomId = roomSelect.value;
        const checkIn = checkInInput.value;
        const checkOut = checkOutInput.value;
        const guests = guestsInput.value;

        if (!roomId || !checkIn || !checkOut || !guests || guests < 1) {
            submitBtn.disabled = true;
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ –ø–æ–∑–∂–µ –∑–∞–µ–∑–¥–∞
        if (new Date(checkOut) <= new Date(checkIn)) {
            submitBtn.disabled = true;
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –∑–∞–Ω—è—Ç—ã—Ö –¥–∞—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        if (!checkRangeForBusyDates(checkIn, checkOut)) {
            submitBtn.disabled = true;
            return;
        }

        submitBtn.disabled = false;
    }

    // –°–º–µ–Ω–∞ –º–µ—Å—è—Ü–∞
    window.changeMonth = function(delta) {
        currentMonth += delta;

        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }

        renderCalendar();
    };

    // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
    roomSelect.addEventListener('change', function() {
        selectedRoomId = this.value;
        if (selectedRoomId) {
            loadBusyDates(selectedRoomId);
            calculateTotal();
        } else {
            busyDates = [];
            renderCalendar();
        }
    });

    checkInInput.addEventListener('change', function() {
        if (this.value && checkOutInput) {
            const minDate = new Date(this.value);
            minDate.setDate(minDate.getDate() + 1);
            checkOutInput.min = minDate.toISOString().split('T')[0];

            if (checkOutInput.value && new Date(checkOutInput.value) <= new Date(this.value)) {
                checkOutInput.value = '';
            }
        }
        calculateTotal();
        renderCalendar();
    });

    checkOutInput.addEventListener('change', function() {
        calculateTotal();
        renderCalendar();
    });

    guestsInput.addEventListener('change', updateSubmitButton);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã
    const today = new Date().toISOString().split('T')[0];
    if (checkInInput) {
        checkInInput.min = today;
        checkInInput.value = today;
    }

    if (checkOutInput) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        checkOutInput.min = tomorrow.toISOString().split('T')[0];
        checkOutInput.value = tomorrow.toISOString().split('T')[0];
    }

    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room_id');
    if (roomId && roomSelect.querySelector(`option[value="${roomId}"]`)) {
        roomSelect.value = roomId;
        selectedRoomId = roomId;

        // –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ –¥–∞—Ç—ã
        setTimeout(() => {
            loadBusyDates(roomId);
            calculateTotal();
        }, 100);
    } else {
        // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø—Ä–æ—Å—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        setTimeout(renderCalendar, 100);
        calculateTotal();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateSubmitButton();
});
</script>

<style>
.calendar-grid {
    font-size: 14px;
}

.calendar-day {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 8px 4px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    background-color: white;
    width: 100%;
}

.calendar-day:hover:not(:disabled) {
    background-color: #f8f9fa;
    transform: translateY(-1px);
}

.calendar-day.today {
    border-color: #0dcaf0;
    background-color: #e3f2fd;
    font-weight: bold;
}

.calendar-day.past {
    color: #adb5bd;
    cursor: not-allowed;
    background-color: #f8f9fa;
}

.calendar-day.busy {
    background-color: #f8d7da;
    color: #721c24;
    cursor: not-allowed;
    border-color: #f5c2c7;
}

.calendar-day.busy:hover {
    background-color: #f8d7da;
    transform: none;
}

.calendar-day.selected {
    background-color: #d1e7dd;
    color: #0f5132;
    border-color: #198754;
    font-weight: bold;
}

.calendar-day.in-range {
    background-color: #e7f5ef;
    color: #0f5132;
}

.calendar-day:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.row {
    margin-bottom: 2px;
}

.col {
    padding: 2px;
}
</style>
{% endblock %}